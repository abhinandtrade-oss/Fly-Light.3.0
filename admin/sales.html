<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Detailed Sales Tracking - FLTT </title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="../assets/images/favicons/fev.admin.png" type="image/png">
    <link rel="icon" href="../assets/images/favicons/fev.admin.png" type="image/png">

    <!-- Icons -->
    <link rel="stylesheet" href="../assets/vendors/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="../assets/vendors/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../assets/css/admin-common.css" />

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--content-bg);
            color: var(--text-dark);
            margin: 0;
            display: none;
        }

        .sales-tabs {
            display: flex;
            gap: 20px;
            margin-bottom: 30px;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 10px;
        }

        .sales-tab {
            padding: 8px 20px;
            cursor: pointer;
            font-weight: 600;
            color: var(--text-muted);
            border-radius: 8px;
            transition: 0.3s;
        }

        .sales-tab.active {
            color: var(--primary);
            background: rgba(232, 96, 76, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.05);
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .stat-icon {
            width: 50px;
            height: 50px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-info .label {
            font-size: 0.85rem;
            color: #64748b;
            margin-bottom: 4px;
        }

        .stat-info .value {
            font-size: 1.25rem;
            font-weight: 700;
            color: #1e293b;
        }

        .filter-bar {
            background: #fff;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            align-items: flex-end;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
        }

        .ref-num {
            font-family: monospace;
            font-weight: 700;
            color: var(--primary);
            font-size: 0.9rem;
        }

        .status-badge {
            font-size: 0.75rem;
            padding: 4px 8px;
            border-radius: 6px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .payment-pending {
            background: #fee2e2;
            color: #ef4444;
        }

        .payment-advance {
            background: #fef9c3;
            color: #a16207;
        }

        .payment-full {
            background: #dcfce7;
            color: #16a34a;
        }

        .payment-refund {
            background: #f3f4f6;
            color: #4b5563;
        }

        .service-pending {
            background: #fff7ed;
            color: #c2410c;
        }

        .service-issued {
            background: #ecfdf5;
            color: #059669;
        }

        .service-cancelled {
            background: #fef2f2;
            color: #b91c1c;
        }

        .form-section-title {
            font-size: 0.9rem;
            font-weight: 700;
            color: #64748b;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-top: 20px;
            margin-bottom: 15px;
            padding-bottom: 5px;
            border-bottom: 1px dashed #e2e8f0;
        }

        .calc-box {
            background: #f8fafc;
            padding: 15px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
        }
    </style>
</head>

<body>

    <div class="dashboard-container">
        <div id="sidebar-container"></div>

        <main class="main-content">
            <div class="topbar">
                <div class="user-profile">
                    <div class="user-info">
                        <div class="user-name">Loading...</div>
                        <div class="user-role">...</div>
                    </div>
                    <div class="avatar">?</div>
                    <button onclick="handleLogout()" class="btn btn-outline-danger btn-sm ms-3"
                        style="border-radius: 50%; width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <div class="content-wrapper">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="page-title m-0">Sales Tracking</h1>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-info" id="manage-types-btn" style="display: none;"
                            data-bs-toggle="modal" data-bs-target="#serviceTypesModal">
                            <i class="fas fa-tags me-2"></i> Service Types
                        </button>
                        <button class="btn btn-custom" onclick="openNewSaleModal()">
                            <i class="fas fa-plus me-2"></i> New Sale Entry
                        </button>
                    </div>
                </div>

                <!-- Admin Analytics -->
                <div id="admin-analytics" style="display: none;">
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon bg-primary text-white">
                                <i class="fas fa-hand-holding-usd"></i>
                            </div>
                            <div class="stat-info">
                                <div class="label">Total Margin (Today)</div>
                                <div class="value" id="stats-margin-today">₹0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-success text-white">
                                <i class="fas fa-wallet"></i>
                            </div>
                            <div class="stat-info">
                                <div class="label">Balance to Receive</div>
                                <div class="value" id="stats-balance-total">₹0</div>
                            </div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-icon bg-warning text-white">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-info">
                                <div class="label">Monthly Bookings</div>
                                <div class="value" id="stats-count-month">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="sales-tabs">
                    <div class="sales-tab active" onclick="switchSalesTab('my')">My Entries</div>
                    <div id="tab-all-sales" class="sales-tab" onclick="switchSalesTab('all')" style="display: none;">All
                        Team Sales</div>
                    <div id="tab-approvals" class="sales-tab" onclick="switchSalesTab('approvals')"
                        style="display: none;">
                        Deletion Approvals <span id="approval-badge" class="badge bg-danger ms-1"
                            style="display: none;">0</span>
                    </div>
                </div>

                <!-- Filter & Search Bar -->
                <div class="filter-bar" id="sales-controls">
                    <div style="flex: 2; min-width: 250px;">
                        <label class="form-label small fw-bold">Search (Ref, Doc#, Cust, Contact, Plat)</label>
                        <div class="input-group">
                            <span class="input-group-text bg-white border-end-0"><i
                                    class="fas fa-search text-muted"></i></span>
                            <input type="text" id="filter-search" class="form-control border-start-0"
                                placeholder="Type to search..." oninput="applyFilters()">
                        </div>
                    </div>

                    <div id="admin-filters-group" style="display: contents;">
                        <div style="width: 140px;">
                            <label class="form-label small fw-bold">User</label>
                            <select id="filter-user" class="form-select" onchange="applyFilters()">
                                <option value="all">All Users</option>
                            </select>
                        </div>
                    </div>

                    <div style="width: 140px;">
                        <label class="form-label small fw-bold">Service</label>
                        <select id="filter-service" class="form-select" onchange="applyFilters()">
                            <option value="all">All Services</option>
                        </select>
                    </div>

                    <div style="width: 140px;">
                        <label class="form-label small fw-bold">Pay Status</label>
                        <select id="filter-pay-status" class="form-select" onchange="applyFilters()">
                            <option value="all">All</option>
                            <option value="payment pending">Pending</option>
                            <option value="advance received">Advance</option>
                            <option value="full payment received">Full</option>
                            <option value="refund">Refund</option>
                        </select>
                    </div>

                    <div style="width: 140px;">
                        <label class="form-label small fw-bold">Sort By</label>
                        <select id="filter-sort" class="form-select" onchange="applyFilters()">
                            <option value="sale_date_desc">Date (Newest)</option>
                            <option value="sale_date_asc">Date (Oldest)</option>
                            <option value="customer_name_asc">Name (A-Z)</option>
                            <option value="final_price_desc">Price (High-Low)</option>
                        </select>
                    </div>

                    <div class="d-flex gap-2 align-items-end">
                        <button class="btn btn-outline-success" onclick="downloadCSV()" title="Download CSV">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="btn btn-outline-secondary" onclick="resetFilters()" title="Reset">
                            <i class="fas fa-undo"></i>
                        </button>
                    </div>
                </div>

                <div class="content-card" id="sales-table-card">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Ref Num / Date</th>
                                    <th class="col-user" style="display: none;">Emp Email</th>
                                    <th>Customer / Service</th>
                                    <th>Pricing</th>
                                    <th>Status</th>
                                    <th style="width: 100px;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="salesTableBody">
                                <!-- Injected -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <div class="content-card" id="approvals-table-card" style="display: none;">
                    <div class="table-responsive">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Source Entry</th>
                                    <th>Requested By</th>
                                    <th>Reason for Deletion</th>
                                    <th>Date</th>
                                    <th style="width: 200px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="approvalsTableBody">
                                <!-- Injected -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Deletion Request Modal -->
    <div class="modal fade" id="deleteRequestModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-warning text-dark">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i> Request Deletion</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <p>Standard users cannot delete entries directly. Your request will be sent to admins for approval.
                    </p>
                    <div class="mb-3">
                        <label class="form-label fw-600">Why do you want to delete this record?</label>
                        <textarea id="delete-reason" class="form-control" rows="3"
                            placeholder="Incorrect entry, duplicate, customer cancelled, etc." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-warning px-4" id="submitDeleteRequestBtn">Submit
                        Request</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Rejection Reason Modal -->
    <div class="modal fade" id="rejectionModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-times-circle me-2"></i> Reject Deletion Request</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="mb-3">
                        <label class="form-label fw-600">Reason for Rejection</label>
                        <textarea id="rejection-feedback" class="form-control" rows="3"
                            placeholder="Provide feedback to the user..." required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger px-4" id="confirmRejectBtn">Reject Request</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Sale Modal -->
    <div class="modal fade" id="saleModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-custom text-white">
                    <h5 class="modal-title"><i class="fas fa-file-invoice-dollar me-2"></i> Sale Recording</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4" style="max-height: 80vh; overflow-y: auto;">
                    <form id="saleForm">
                        <!-- Section 1: General -->
                        <div class="form-section-title mt-0">General Information</div>
                        <div class="row g-3">
                            <div class="col-md-4">
                                <label class="form-label fw-600">Reference Num</label>
                                <input type="text" id="ref_num" class="form-control bg-light" readonly>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-600">Sale Date</label>
                                <input type="date" id="sale_date" class="form-control" required
                                    onchange="generateRefNum()">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-600">Service Type</label>
                                <select id="service_type" class="form-select" required></select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-600">Affiliated Platform</label>
                                <input type="text" id="affiliated_platform" class="form-control"
                                    placeholder="e.g. Akbar, TBO, Agoda">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-600">Employee Email</label>
                                <input type="text" id="emp_email" class="form-control bg-light" readonly>
                            </div>
                        </div>

                        <!-- Section 2: Customer -->
                        <div class="form-section-title">Customer Details</div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-600">Customer Name</label>
                                <input type="text" id="customer_name" class="form-control" required>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-600">Contact / Email</label>
                                <input type="text" id="customer_details" class="form-control"
                                    placeholder="Phone or Email">
                            </div>
                            <div class="col-12">
                                <label class="form-label fw-600">Requirements & Specifics</label>
                                <textarea id="requirements" class="form-control" rows="2"
                                    placeholder="Flight routes, bed type, etc."></textarea>
                            </div>
                        </div>

                        <!-- Section 3: Pricing -->
                        <div class="form-section-title">Pricing & Payments</div>
                        <div class="row g-3">
                            <div class="col-md-3">
                                <label class="form-label fw-600">B2B Price (₹)</label>
                                <input type="number" id="b2b_price" class="form-control price-input" value="0"
                                    step="0.01">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-600">Margin (₹)</label>
                                <input type="number" id="margin" class="form-control price-input" value="0" step="0.01">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-600">Discount (₹)</label>
                                <input type="number" id="discount" class="form-control price-input" value="0"
                                    step="0.01">
                            </div>
                            <div class="col-md-3">
                                <label class="form-label fw-600 text-primary">Final Price (₹)</label>
                                <div id="calc_final" class="form-control bg-primary text-white fw-bold">₹0.00</div>
                            </div>

                            <div class="col-md-4">
                                <label class="form-label fw-600">Advance Received (₹)</label>
                                <input type="number" id="advance_received" class="form-control price-input" value="0"
                                    step="0.01">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-600">Cust. Direct Pay Provider (₹)</label>
                                <input type="number" id="cust_direct_pay" class="form-control price-input" value="0"
                                    step="0.01">
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-600 text-danger">Balance Due (₹)</label>
                                <div id="calc_balance"
                                    class="form-control bg-danger-subtle text-danger fw-bold border-danger">₹0.00</div>
                            </div>
                            <div class="col-md-4">
                                <label class="form-label fw-600">Adv Paid to B2B Provider (₹)</label>
                                <input type="number" id="adv_paid_to_b2b" class="form-control" value="0" step="0.01">
                            </div>
                        </div>

                        <!-- Section 4: Status & Docs -->
                        <div class="form-section-title">Execution & Documentation</div>
                        <div class="row g-3">
                            <div class="col-md-6">
                                <label class="form-label fw-600">Payment Status</label>
                                <select id="payment_status" class="form-select">
                                    <option value="payment pending">Payment Pending</option>
                                    <option value="advance received">Advance Received</option>
                                    <option value="full payment received">Full Payment Received</option>
                                    <option value="refund">Refund</option>
                                </select>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-600">Service Status</label>
                                <select id="service_status" class="form-select">
                                    <option value="pending">Pending</option>
                                    <option value="issued">Issued</option>
                                    <option value="cancelled">Cancelled</option>
                                </select>
                            </div>
                            <div class="col-md-12">
                                <label class="form-label fw-600">Doc Num (PNR / Tkt / Ref)</label>
                                <input type="text" id="doc_num" class="form-control"
                                    placeholder="Combine multiple with commas">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-600">Document Link (Image/PDF)</label>
                                <div class="input-group">
                                    <input type="url" id="doc_link" class="form-control" placeholder="https://...">
                                    <button type="button" class="btn btn-outline-primary"
                                        onclick="document.getElementById('file_upload_input').click()" id="uploadBtn">
                                        <i class="fas fa-upload"></i> Upload
                                    </button>
                                </div>
                                <input type="file" id="file_upload_input" style="display: none;"
                                    onchange="window.handleFileUpload(this)" accept="image/*,.pdf">
                                <div id="upload_status" class="small mt-1" style="display: none;"></div>
                            </div>
                            <div class="col-md-6">
                                <label class="form-label fw-600">Internal Remarks</label>
                                <input type="text" id="remarks" class="form-control">
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-custom px-4" id="saveSaleBtn">Save Sale Entry</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Email Send Modal -->
    <div class="modal fade" id="emailSendModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="fas fa-paper-plane me-2"></i> Send to Customer</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <div id="email-preview" class="p-3 bg-light rounded small mb-3"
                        style="max-height: 200px; overflow-y: auto;">
                        <!-- Preview injected -->
                    </div>
                    <form id="emailSendForm">
                        <div class="mb-3">
                            <label class="form-label fw-600">Customer Email</label>
                            <input type="email" id="target_email" class="form-control"
                                placeholder="customer@example.com" required>
                        </div>
                        <div class="mb-3">
                            <label class="form-label fw-600">Additional Note</label>
                            <textarea id="email_note" class="form-control" rows="2"
                                placeholder="Hi, please find your booking details..."></textarea>
                        </div>
                        <div class="small text-muted mb-0">
                            <i class="fas fa-user-lock me-1"></i> Will be sent via your configured SMTP account.
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-success px-4" id="confirmSendBtn">Send Email Now</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Details View Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0">
                <div class="modal-header">
                    <h5 class="modal-title">Sale Record: <span id="view-ref" class="ref-num"></span></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4" id="details-content">
                    <!-- Injected by JS -->
                </div>
            </div>
        </div>
    </div>

    <!-- Email Logs Modal -->
    <div class="modal fade" id="emailLogsModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-info text-white">
                    <h5 class="modal-title"><i class="fas fa-history me-2"></i> Email History</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Date & Time</th>
                                    <th>Sent By</th>
                                    <th>To</th>
                                    <th>Status</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody id="emailLogsBody">
                                <!-- Injected -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <div class="modal-footer bg-light">
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Service Types Modal -->
    <div class="modal fade" id="serviceTypesModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Manage Service Types</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="input-group mb-3">
                        <input type="text" id="new-service-name" class="form-control"
                            placeholder="e.g. VISA ASSISTANCE">
                        <button class="btn btn-primary" onclick="addServiceType()">Add</button>
                    </div>
                    <ul class="list-group" id="service-types-list"></ul>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="../assets/js/admin-sidebar-loader.js"></script>
    <script type="module" src="../assets/js/admin-announcement-checker.js"></script>
    <script src="../assets/vendors/bootstrap/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { supabase, fetchContent, saveContent } from '../assets/js/supabase-client.js';

        let currentUser = null;
        let currentUserRole = 'viewer';
        let allSales = [];
        let emailLogs = [];
        let filteredSales = [];
        let deletionRequests = [];
        let currentTab = 'my';
        let editingSaleId = null;
        let serviceTypes = ["FLIGHT TKT", "BUS TKT", "room reservation", "travel insur.", "tour package", "Escort", "Property enlisting"];

        // Init
        async function init() {
            const { data: { session } } = await supabase.auth.getSession();
            if (!session) {
                window.location.href = 'login.html';
                return;
            }
            currentUser = session.user;

            const dRegistry = await fetchContent('admin_users_registry');
            const userRegistry = dRegistry ? JSON.parse(dRegistry) : [];
            const userEntry = userRegistry.find(u => u.email.toLowerCase() === currentUser.email.toLowerCase());
            currentUserRole = userEntry?.role || currentUser.user_metadata?.role || (userRegistry.length === 0 ? 'super_admin' : 'viewer');



            const isAdmin = ['admin', 'super_admin'].includes(currentUserRole);
            if (isAdmin) {
                document.getElementById('tab-all-sales').style.display = 'block';
                document.getElementById('tab-approvals').style.display = 'block';
                document.getElementById('admin-analytics').style.display = 'block';
                document.getElementById('manage-types-btn').style.display = 'block';
                populateFilters();
            }

            await loadServiceTypes();
            await loadRequests();
            await loadSales();
            document.body.style.display = 'block';

            // Setup price calculation listeners
            document.querySelectorAll('.price-input').forEach(input => {
                input.addEventListener('input', calculateLivePrice);
            });

            document.getElementById('saveSaleBtn').onclick = submitSale;
        }

        async function loadServiceTypes() {
            const dTypes = await fetchContent('sales_service_types');
            if (dTypes) {
                try { serviceTypes = JSON.parse(dTypes); } catch (e) { }
            }
            renderServiceTypesUI();
        }

        async function loadRequests() {
            const data = await fetchContent('sales_deletion_requests');
            deletionRequests = data ? JSON.parse(data) : [];
            updateApprovalBadge();
        }

        function updateApprovalBadge() {
            const pendingReqs = deletionRequests.filter(r => r.status === 'pending');
            const badge = document.getElementById('approval-badge');
            if (badge) {
                if (pendingReqs.length > 0) {
                    badge.innerText = pendingReqs.length;
                    badge.style.display = 'inline-block';
                } else {
                    badge.style.display = 'none';
                }
            }
        }

        function renderServiceTypesUI() {
            const select = document.getElementById('service_type');
            select.innerHTML = serviceTypes.map(t => `<option value="${t}">${t}</option>`).join('');

            const list = document.getElementById('service-types-list');
            list.innerHTML = serviceTypes.map(t => `
                <li class="list-group-item d-flex justify-content-between align-items-center">
                    ${t}
                    <button class="btn btn-sm text-danger" onclick="removeServiceType('${t}')"><i class="fas fa-trash"></i></button>
                </li>
            `).join('');

            const filterSelect = document.getElementById('filter-service');
            if (filterSelect) {
                const currentVal = filterSelect.value;
                filterSelect.innerHTML = '<option value="all">All Services</option>' + serviceTypes.map(t => `<option value="${t}">${t}</option>`).join('');
                filterSelect.value = currentVal;
            }
        }

        window.addServiceType = async () => {
            const name = document.getElementById('new-service-name').value.trim().toUpperCase();
            if (!name) return;
            if (!serviceTypes.includes(name)) {
                serviceTypes.push(name);
                await saveContent('sales_service_types', JSON.stringify(serviceTypes));
                renderServiceTypesUI();
                document.getElementById('new-service-name').value = '';
                window.showAlert('Service type added', 'success');
            }
        };

        window.removeServiceType = async (name) => {
            const confirmed = await window.showConfirm('Remove Service', `Are you sure you want to remove "${name}" from the service types?`);
            if (confirmed) {
                serviceTypes = serviceTypes.filter(t => t !== name);
                await saveContent('sales_service_types', JSON.stringify(serviceTypes));
                renderServiceTypesUI();
            }
        };

        async function loadSales() {
            const { data, error } = await supabase.from('sales').select('*').order('sale_date', { ascending: false });
            if (error) {
                window.showAlert('Error: ' + error.message, 'error');
                return;
            }
            allSales = data;

            // Load Email Logs
            const { data: logs } = await supabase.from('sales_email_logs').select('*');
            emailLogs = logs || [];

            calculateStats();
            switchSalesTab(currentTab);
        }

        function calculateStats() {
            const now = new Date();
            const todayStr = now.toISOString().split('T')[0];
            const currentMonth = now.getMonth();
            const currentYear = now.getFullYear();

            const marginToday = allSales
                .filter(s => s.sale_date === todayStr)
                .reduce((sum, s) => sum + parseFloat(s.margin), 0);

            const balanceTotal = allSales.reduce((sum, s) => sum + parseFloat(s.balance_to_receive), 0);

            const monthCount = allSales.filter(s => {
                const d = new Date(s.sale_date);
                return d.getMonth() === currentMonth && d.getFullYear() === currentYear;
            }).length;

            document.getElementById('stats-margin-today').innerText = `₹${marginToday.toLocaleString()}`;
            document.getElementById('stats-balance-total').innerText = `₹${balanceTotal.toLocaleString()}`;
            document.getElementById('stats-count-month').innerText = monthCount;
        }

        window.openNewSaleModal = () => {
            editingSaleId = null;
            const form = document.getElementById('saleForm');
            form.reset();
            document.getElementById('sale_date').valueAsDate = new Date();
            document.getElementById('emp_email').value = currentUser.email;
            document.getElementById('saveSaleBtn').innerText = 'Save Sale Entry';
            generateRefNum();
            calculateLivePrice();
            new bootstrap.Modal(document.getElementById('saleModal')).show();
        };

        window.handleFileUpload = async (input) => {
            const file = input.files[0];
            if (!file) return;

            // Size check: Max 5MB
            if (file.size > 5 * 1024 * 1024) {
                window.showAlert('File exceeds 5MB limit', 'warning');
                input.value = '';
                return;
            }

            const statusEl = document.getElementById('upload_status');
            const uploadBtn = document.getElementById('uploadBtn');
            const docLinkInput = document.getElementById('doc_link');
            const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxjKXmOAezGosL9cyDMI2MZvVbrfqH5FsObws_cIYb4b8WjBkFowMNkpYyZh-1eq7u-WQ/exec';

            try {
                // Show loading state
                statusEl.style.display = 'block';
                statusEl.className = 'small mt-1 text-primary';
                statusEl.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Uploading...';
                uploadBtn.disabled = true;

                const reader = new FileReader();
                reader.readAsDataURL(file);
                reader.onload = async () => {
                    const base64Data = reader.result.split(',')[1];
                    const payload = {
                        image: base64Data,
                        mimeType: file.type,
                        userEmail: currentUser?.email || 'Anonymous',
                        sheetName: 'sales_docs',
                        source: 'sales_page'
                    };

                    try {
                        const res = await fetch(SCRIPT_URL, {
                            method: 'POST',
                            body: JSON.stringify(payload)
                        });
                        const data = await res.json();

                        if (data.result === 'success') {
                            docLinkInput.value = data.url;
                            statusEl.className = 'small mt-1 text-success';
                            statusEl.innerHTML = '<i class="fas fa-check-circle me-1"></i> Uploaded successfully!';
                            window.showAlert('Document uploaded successfully', 'success');
                        } else {
                            throw new Error(data.message || 'Upload failed');
                        }
                    } catch (err) {
                        console.error('Upload error:', err);
                        statusEl.className = 'small mt-1 text-danger';
                        statusEl.innerHTML = '<i class="fas fa-times-circle me-1"></i> Upload failed. Try again.';
                        window.showAlert('Upload failed. Please check your connection or CORS settings.', 'error');
                    } finally {
                        uploadBtn.disabled = false;
                        input.value = ''; // Reset input
                    }
                };
            } catch (err) {
                console.error(err);
                window.showAlert('Error processing file', 'error');
                uploadBtn.disabled = false;
            }
        };

        window.editSale = (id) => {
            const s = allSales.find(x => x.id == id);
            if (!s) return;

            editingSaleId = id;
            document.getElementById('ref_num').value = s.ref_num;
            document.getElementById('sale_date').value = s.sale_date;
            document.getElementById('service_type').value = s.service_type;
            document.getElementById('affiliated_platform').value = s.affiliated_platform || '';
            document.getElementById('emp_email').value = s.user_email;
            document.getElementById('customer_name').value = s.customer_name;
            document.getElementById('customer_details').value = s.customer_details || '';
            document.getElementById('requirements').value = s.requirements || '';
            document.getElementById('b2b_price').value = s.b2b_price;
            document.getElementById('margin').value = s.margin;
            document.getElementById('discount').value = s.discount;
            document.getElementById('advance_received').value = s.advance_received;
            document.getElementById('adv_paid_to_b2b').value = s.adv_paid_to_b2b;
            document.getElementById('cust_direct_pay').value = s.cust_direct_pay;
            document.getElementById('payment_status').value = s.payment_status;
            document.getElementById('service_status').value = s.service_status;
            document.getElementById('doc_num').value = s.doc_num || '';
            document.getElementById('doc_link').value = s.doc_link || '';
            document.getElementById('remarks').value = s.remarks || '';

            document.getElementById('saveSaleBtn').innerText = 'Update Sale Entry';
            calculateLivePrice();
            new bootstrap.Modal(document.getElementById('saleModal')).show();
        };

        window.generateRefNum = async () => {
            const dateInput = document.getElementById('sale_date').value;
            if (!dateInput) return;

            const date = new Date(dateInput);
            const ddmm = String(date.getDate()).padStart(2, '0') + String(date.getMonth() + 1).padStart(2, '0');
            const yyyy = date.getFullYear();

            // Count existing sales for this specific date in allSales
            const countForDay = allSales.filter(s => s.sale_date === dateInput).length;
            const sl = String(countForDay + 1).padStart(2, '0');

            document.getElementById('ref_num').value = `FLTT-${ddmm}-${sl}-${yyyy}`;
        };

        function calculateLivePrice() {
            const b2b = parseFloat(document.getElementById('b2b_price').value) || 0;
            const margin = parseFloat(document.getElementById('margin').value) || 0;
            const disc = parseFloat(document.getElementById('discount').value) || 0;
            const advRec = parseFloat(document.getElementById('advance_received').value) || 0;
            const direct = parseFloat(document.getElementById('cust_direct_pay').value) || 0;

            const final = b2b + margin - disc;
            const balance = final - advRec - direct;

            document.getElementById('calc_final').innerText = `₹${final.toFixed(2)}`;
            document.getElementById('calc_balance').innerText = `₹${balance.toFixed(2)}`;
        }

        async function submitSale() {
            const form = document.getElementById('saleForm');
            if (!form.checkValidity()) {
                form.reportValidity();
                return;
            }

            const isEdit = !!editingSaleId;
            const confirmed = await window.showConfirm(isEdit ? 'Update Sale' : 'Save Sale', `Are you sure you want to ${isEdit ? 'update' : 'record'} this sale entry?`);
            if (!confirmed) return;

            const payload = {
                sale_date: document.getElementById('sale_date').value,
                service_type: document.getElementById('service_type').value,
                affiliated_platform: document.getElementById('affiliated_platform').value,
                customer_name: document.getElementById('customer_name').value,
                customer_details: document.getElementById('customer_details').value,
                requirements: document.getElementById('requirements').value,
                b2b_price: parseFloat(document.getElementById('b2b_price').value) || 0,
                margin: parseFloat(document.getElementById('margin').value) || 0,
                discount: parseFloat(document.getElementById('discount').value) || 0,
                advance_received: parseFloat(document.getElementById('advance_received').value) || 0,
                adv_paid_to_b2b: parseFloat(document.getElementById('adv_paid_to_b2b').value) || 0,
                cust_direct_pay: parseFloat(document.getElementById('cust_direct_pay').value) || 0,
                payment_status: document.getElementById('payment_status').value,
                service_status: document.getElementById('service_status').value,
                doc_num: document.getElementById('doc_num').value,
                doc_link: document.getElementById('doc_link').value,
                remarks: document.getElementById('remarks').value
            };

            let response;
            if (editingSaleId) {
                response = await supabase.from('sales').update(payload).eq('id', editingSaleId);
            } else {
                payload.user_id = currentUser.id;
                payload.user_email = currentUser.email;
                payload.ref_num = document.getElementById('ref_num').value;
                response = await supabase.from('sales').insert([payload]);
            }

            if (response.error) {
                window.showAlert('Failed to save: ' + response.error.message, 'error');
            } else {
                window.showAlert(editingSaleId ? 'Sale record updated' : 'Sale record saved', 'success');
                bootstrap.Modal.getInstance(document.getElementById('saleModal')).hide();
                loadSales();
            }
        }

        window.switchSalesTab = (tab) => {
            currentTab = tab;
            document.querySelectorAll('.sales-tab').forEach(el => el.classList.remove('active'));
            if (event?.target) event.target.classList.add('active');

            const isAdminView = currentTab === 'all';
            const isApprovalsView = currentTab === 'approvals';

            document.getElementById('sales-controls').style.display = isApprovalsView ? 'none' : 'flex';
            document.getElementById('sales-table-card').style.display = isApprovalsView ? 'none' : 'block';
            document.getElementById('approvals-table-card').style.display = isApprovalsView ? 'block' : 'none';

            if (isAdminView || currentTab === 'my') {
                document.getElementById('admin-filters-group').style.display = isAdminView ? 'contents' : 'none';
                document.querySelectorAll('.col-user').forEach(c => c.style.display = isAdminView ? 'table-cell' : 'none');
                applyFilters();
            } else if (isApprovalsView) {
                renderApprovalsTable();
            }
        };

        window.applyFilters = () => {
            const searchQ = document.getElementById('filter-search').value.toLowerCase();
            const userF = document.getElementById('filter-user')?.value || 'all';
            const servF = document.getElementById('filter-service')?.value || 'all';
            const payF = document.getElementById('filter-pay-status')?.value || 'all';
            const sortF = document.getElementById('filter-sort').value;

            // 1. Filtering
            filteredSales = allSales.filter(s => {
                // Tab Context
                const tabMatch = currentTab === 'my' ? s.user_id === currentUser.id : true;
                if (!tabMatch) return false;

                // Simple Filters
                const userMatch = currentTab === 'my' || userF === 'all' || s.user_email === userF;
                const servMatch = servF === 'all' || s.service_type === servF;
                const payMatch = payF === 'all' || s.payment_status === payF;

                // Search Query (Multiple Fields)
                const searchMatch = !searchQ ||
                    s.ref_num.toLowerCase().includes(searchQ) ||
                    s.customer_name.toLowerCase().includes(searchQ) ||
                    (s.customer_details && s.customer_details.toLowerCase().includes(searchQ)) ||
                    (s.doc_num && s.doc_num.toLowerCase().includes(searchQ)) ||
                    (s.affiliated_platform && s.affiliated_platform.toLowerCase().includes(searchQ)) ||
                    (s.user_email && s.user_email.toLowerCase().includes(searchQ));

                return userMatch && servMatch && payMatch && searchMatch;
            });

            // 2. Sorting
            filteredSales.sort((a, b) => {
                switch (sortF) {
                    case 'sale_date_desc': return new Date(b.sale_date) - new Date(a.sale_date);
                    case 'sale_date_asc': return new Date(a.sale_date) - new Date(b.sale_date);
                    case 'customer_name_asc': return a.customer_name.localeCompare(b.customer_name);
                    case 'final_price_desc': return parseFloat(b.final_price) - parseFloat(a.final_price);
                    default: return 0;
                }
            });

            renderTable();
        };

        window.resetFilters = () => {
            document.getElementById('filter-search').value = '';
            document.getElementById('filter-user').value = 'all';
            document.getElementById('filter-service').value = 'all';
            document.getElementById('filter-pay-status').value = 'all';
            document.getElementById('filter-sort').value = 'sale_date_desc';
            applyFilters();
        };

        function renderTable() {
            const tbody = document.getElementById('salesTableBody');
            const isAdminView = currentTab === 'all';

            tbody.innerHTML = filteredSales.map(s => {
                const req = deletionRequests.find(r => r.sale_id == s.id && r.status === 'pending');
                const rejected = deletionRequests.find(r => r.sale_id == s.id && r.status === 'rejected');
                const sLogs = emailLogs.filter(l => l.sale_id == s.id);
                const emailCount = sLogs.length;

                return `
                <tr>
                    <td>
                        <div class="ref-num">${s.ref_num}</div>
                        <div class="small text-muted">${new Date(s.sale_date).toLocaleDateString()}</div>
                    </td>
                    <td class="col-user" style="display: ${isAdminView ? 'table-cell' : 'none'}">
                        <span class="small fw-600">${s.user_email}</span>
                    </td>
                    <td>
                        <div class="fw-bold">${s.customer_name}</div>
                        <div class="small text-primary">${s.service_type}</div>
                    </td>
                    <td>
                        <div class="fw-bold">₹${parseFloat(s.final_price).toLocaleString()}</div>
                        <div class="small text-danger">Bal: ₹${parseFloat(s.balance_to_receive).toLocaleString()}</div>
                    </td>
                    <td>
                        <div><span class="status-badge payment-${s.payment_status.replace(' ', '-')}">${s.payment_status}</span></div>
                        <div class="mt-1"><span class="status-badge service-${s.service_status}">${s.service_status}</span></div>
                        ${req ? `<div class="mt-1"><span class="badge bg-warning text-dark" style="font-size: 10px;"><i class="fas fa-clock me-1"></i> Delete Requested</span></div>` : ''}
                        ${rejected ? `
                            <div class="mt-2 p-2 bg-danger-subtle border border-danger rounded" style="max-width: 180px;">
                                <div class="badge bg-danger mb-1" style="font-size: 9px;"><i class="fas fa-times-circle me-1"></i> Delete Rejected</div>
                                <div class="text-danger fw-bold" style="font-size: 10px;">Reason:</div>
                                <div class="text-dark" style="font-size: 10px; line-height: 1.2;">${rejected.admin_feedback}</div>
                                <button class="btn btn-link btn-sm p-0 mt-1 text-danger" style="font-size: 9px; text-decoration: none;" onclick="clearRejection('${s.id}')">Dismiss</button>
                            </div>
                        ` : ''}
                        ${emailCount > 0 ? `
                            <div class="mt-2" style="cursor: pointer;" onclick="viewEmailLogs('${s.id}')">
                                <span class="badge bg-info text-white" title="Click to view email history">
                                    <i class="fas fa-envelope-open-text me-1"></i> ${emailCount} Email${emailCount > 1 ? 's' : ''} Sent
                                </span>
                            </div>
                        ` : ''}
                    </td>
                    <td>
                        <div class="d-flex gap-1">
                            <button class="btn btn-sm btn-link" onclick="viewDetails('${s.id}')" title="View Details"><i class="fas fa-eye"></i></button>
                            <button class="btn btn-sm btn-link text-success" onclick="openEmailModal('${s.id}')" title="Send to Customer"><i class="fas fa-envelope"></i></button>
                            ${(s.user_id === currentUser.id || ['admin', 'super_admin'].includes(currentUserRole)) ? `
                                <button class="btn btn-sm btn-link text-primary" onclick="editSale('${s.id}')" title="Edit Entry"><i class="fas fa-edit"></i></button>
                                <button class="btn btn-sm btn-link text-danger" onclick="deleteSale('${s.id}')" title="Delete Entry" ${req ? 'disabled' : ''}>
                                    <i class="fas fa-trash"></i>
                                </button>
                            ` : ''}
                        </div>
                    </td>
                </tr>
            `}).join('') || '<tr><td colspan="6" class="text-center py-5 text-muted">No sales recordings found.</td></tr>';
        }

        window.viewDetails = (id) => {
            const s = allSales.find(x => x.id == id);
            if (!s) return;

            document.getElementById('view-ref').innerText = s.ref_num;
            document.getElementById('details-content').innerHTML = `
                <div class="row">
                    <div class="col-md-6 mb-3"><strong>Employee:</strong> ${s.user_email}</div>
                    <div class="col-md-6 mb-3"><strong>Sale Date:</strong> ${s.sale_date}</div>
                    <div class="col-md-6 mb-3"><strong>Service:</strong> ${s.service_type}</div>
                    <div class="col-md-6 mb-3"><strong>Platform:</strong> ${s.affiliated_platform || 'N/A'}</div>
                    <hr>
                    <div class="col-md-6 mb-3"><strong>Customer:</strong> ${s.customer_name}</div>
                    <div class="col-md-6 mb-3"><strong>Contact:</strong> ${s.customer_details || 'N/A'}</div>
                    <div class="col-12 mb-3"><strong>Requirements:</strong> ${s.requirements || 'N/A'}</div>
                    <hr>
                    <div class="col-md-3 mb-3"><strong>B2B Price:</strong> ₹${s.b2b_price}</div>
                    <div class="col-md-3 mb-3"><strong>Margin:</strong> ₹${s.margin}</div>
                    <div class="col-md-3 mb-3"><strong>Discount:</strong> ₹${s.discount}</div>
                    <div class="col-md-3 mb-3"><strong>Final Price:</strong> ₹${s.final_price}</div>
                    <div class="col-md-4 mb-3"><strong>Adv Received:</strong> ₹${s.advance_received}</div>
                    <div class="col-md-4 mb-3"><strong>Cust Direct Pay:</strong> ₹${s.cust_direct_pay}</div>
                    <div class="col-md-4 mb-3"><strong class="text-danger">Balance:</strong> ₹${s.balance_to_receive}</div>
                    <hr>
                    <div class="col-md-6 mb-3"><strong>Payment Status:</strong> ${s.payment_status}</div>
                    <div class="col-md-6 mb-3"><strong>Service Status:</strong> ${s.service_status}</div>
                    <div class="col-md-12 mb-3"><strong>Doc Num:</strong> ${s.doc_num || 'N/A'}</div>
                    <div class="col-md-12 mb-3"><strong>Doc Link:</strong> ${s.doc_link ? `<a href="${s.doc_link}" target="_blank">View Document</a>` : 'N/A'}</div>
                    <div class="col-md-12 mb-3"><strong>Remarks:</strong> ${s.remarks || 'N/A'}</div>
                </div>
            `;
            new bootstrap.Modal(document.getElementById('detailsModal')).show();
        };

        window.deleteSale = async (id) => {
            const isAdmin = ['admin', 'super_admin'].includes(currentUserRole);

            if (isAdmin) {
                if (await window.showConfirm('Delete Entry', 'Are you sure you want to delete this detailed sales record permanently?')) {
                    const { error } = await supabase.from('sales').delete().eq('id', id);
                    if (error) window.showAlert('Delete failed: ' + error.message, 'error');
                    else {
                        window.showAlert('Record deleted', 'success');
                        // Also remove any requests for this sale
                        await loadRequests();
                        deletionRequests = deletionRequests.filter(r => String(r.sale_id) !== String(id));
                        await saveContent('sales_deletion_requests', JSON.stringify(deletionRequests));
                        loadSales();
                    }
                }
            } else {
                // Request Deletion
                const sale = allSales.find(s => String(s.id) === String(id));
                if (!sale) return;

                document.getElementById('delete-reason').value = '';
                const modal = new bootstrap.Modal(document.getElementById('deleteRequestModal'));
                document.getElementById('submitDeleteRequestBtn').onclick = async () => {
                    const reason = document.getElementById('delete-reason').value.trim();
                    if (!reason) return window.showAlert('Please provide a reason', 'warning');

                    // Pull latest to avoid overwritting other people's requests
                    await loadRequests();

                    const request = {
                        id: 'REQ-' + Date.now(),
                        sale_id: String(id),
                        ref_num: sale.ref_num,
                        requested_by_email: currentUser.email,
                        requested_by_id: currentUser.id,
                        reason: reason,
                        status: 'pending',
                        created_at: new Date().toISOString()
                    };

                    deletionRequests = deletionRequests.filter(r => String(r.sale_id) !== String(id));
                    deletionRequests.push(request);
                    await saveContent('sales_deletion_requests', JSON.stringify(deletionRequests));
                    window.showAlert('Deletion request submitted to Admin', 'success');
                    modal.hide();
                    renderTable();
                };
                modal.show();
            }
        };

        window.clearRejection = async (saleId) => {
            await loadRequests();
            deletionRequests = deletionRequests.filter(r => !(String(r.sale_id) === String(saleId) && r.status === 'rejected'));
            await saveContent('sales_deletion_requests', JSON.stringify(deletionRequests));
            renderTable();
        };

        function renderApprovalsTable() {
            const tbody = document.getElementById('approvalsTableBody');
            const pendingReqs = deletionRequests.filter(r => r.status === 'pending');

            tbody.innerHTML = pendingReqs.map(r => `
                <tr>
                    <td>
                        <div class="fw-bold">${r.ref_num}</div>
                        <div class="small text-muted">ID: ${r.sale_id}</div>
                    </td>
                    <td>
                        <div class="fw-600">${r.requested_by_email}</div>
                    </td>
                    <td>
                        <div class="p-2 bg-light rounded small" style="max-width: 300px; white-space: pre-wrap;">${r.reason}</div>
                    </td>
                    <td>
                        <div class="small">${new Date(r.created_at).toLocaleString()}</div>
                    </td>
                    <td class="text-center">
                        <div class="d-flex gap-2 justify-content-center">
                            <button class="btn btn-sm btn-success px-3" onclick="handleApproval('${r.id}', true)">Approve</button>
                            <button class="btn btn-sm btn-danger px-3" onclick="handleApproval('${r.id}', false)">Reject</button>
                        </div>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="5" class="text-center py-5 text-muted">No pending deletion requests.</td></tr>';
        }

        window.handleApproval = async (requestId, approved) => {
            await loadRequests();
            const req = deletionRequests.find(r => r.id === requestId);
            if (!req) return;

            if (approved) {
                if (await window.showConfirm('Approve Deletion', `Are you sure you want to approve deletion of ${req.ref_num}? This will permanently delete the record.`)) {
                    // 1. Delete from sales table
                    const { error } = await supabase.from('sales').delete().eq('id', req.sale_id);
                    if (error) {
                        return window.showAlert('Approval failed: ' + error.message, 'error');
                    }

                    // 2. Remove from requests (or mark approved)
                    deletionRequests = deletionRequests.filter(r => r.id !== requestId);
                    await saveContent('sales_deletion_requests', JSON.stringify(deletionRequests));

                    window.showAlert('Record deleted successfully', 'success');
                    loadSales();
                    renderApprovalsTable();
                    updateApprovalBadge();
                }
            } else {
                const modal = new bootstrap.Modal(document.getElementById('rejectionModal'));
                document.getElementById('rejection-feedback').value = '';
                document.getElementById('confirmRejectBtn').onclick = async () => {
                    const feedback = document.getElementById('rejection-feedback').value.trim();
                    if (!feedback) return window.showAlert('Please provide feedback', 'warning');

                    req.status = 'rejected';
                    req.admin_feedback = feedback;
                    req.updated_at = new Date().toISOString();

                    await saveContent('sales_deletion_requests', JSON.stringify(deletionRequests));
                    window.showAlert('Deletion request rejected', 'info');
                    modal.hide();
                    renderApprovalsTable();
                    updateApprovalBadge();
                };
                modal.show();
            }
        };

        function populateFilters() {
            const userSelect = document.getElementById('filter-user');
            // Fetch users from registry for the filter
            fetchContent('admin_users_registry').then(d => {
                if (d) {
                    const registry = JSON.parse(d);
                    userSelect.innerHTML = '<option value="all">All Users</option>' +
                        registry.map(u => `<option value="${u.email}">${u.email}</option>`).join('');
                }
            });
        }

        window.downloadCSV = () => {
            if (filteredSales.length === 0) return window.showAlert('No data to export', 'warning');

            const headers = [
                'Reference Num', 'Sale Date', 'Employee Email', 'Service Type', 'Platform',
                'Customer Name', 'Customer Details', 'Requirements',
                'B2B Price', 'Margin', 'Discount', 'Final Price',
                'Advance Received', 'Adv Paid to B2B', 'Cust Direct Pay', 'Balance Due',
                'Payment Status', 'Service Status', 'Doc Num', 'Doc Link', 'Remarks'
            ];

            const rows = filteredSales.map(s => [
                s.ref_num,
                s.sale_date,
                s.user_email,
                s.service_type,
                s.affiliated_platform || '',
                s.customer_name,
                (s.customer_details || '').replace(/,/g, ';'), // Escape commas
                (s.requirements || '').replace(/,/g, ';').replace(/\n/g, ' '),
                s.b2b_price,
                s.margin,
                s.discount,
                s.final_price,
                s.advance_received,
                s.adv_paid_to_b2b,
                s.cust_direct_pay,
                s.balance_to_receive,
                s.payment_status,
                s.service_status,
                (s.doc_num || '').replace(/,/g, ';'),
                s.doc_link || '',
                (s.remarks || '').replace(/,/g, ';').replace(/\n/g, ' ')
            ]);

            const csvContent = [
                headers.join(','),
                ...rows.map(r => r.map(field => `"${field}"`).join(',')) // Quote fields to handle commas
            ].join('\n');

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = `FLTT_Full_Sales_Export_${new Date().toISOString().slice(0, 10)}.csv`;
            link.click();
        };


        let selectedSaleForEmail = null;
        window.openEmailModal = (id) => {
            selectedSaleForEmail = allSales.find(x => x.id == id);
            if (!selectedSaleForEmail) return;

            // Auto-fetch email from customer_details if it looks like one
            const emailRegex = /[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}/;
            const foundEmail = (selectedSaleForEmail.customer_details || '').match(emailRegex);
            document.getElementById('target_email').value = foundEmail ? foundEmail[0] : '';
            document.getElementById('email_note').value = `Greetings ${selectedSaleForEmail.customer_name},\n\nPlease find your booking details below.`;

            document.getElementById('email-preview').innerHTML = `
                <div class="d-flex justify-content-between align-items-start border-bottom pb-2 mb-2">
                    <div>
                        <div class="fw-bold text-primary">${selectedSaleForEmail.ref_num}</div>
                        <div class="text-muted small">${selectedSaleForEmail.service_type}</div>
                    </div>
                    <div class="text-end">
                        <div class="fw-bold">₹${parseFloat(selectedSaleForEmail.final_price).toLocaleString()}</div>
                        <span class="badge ${selectedSaleForEmail.payment_status === 'full payment received' ? 'bg-success' : 'bg-warning text-dark'}">${selectedSaleForEmail.payment_status}</span>
                    </div>
                </div>
                <div class="small">
                    <div><b>Customer:</b> ${selectedSaleForEmail.customer_name}</div>
                    ${selectedSaleForEmail.doc_num ? `<div><b>Doc Num:</b> ${selectedSaleForEmail.doc_num}</div>` : ''}
                </div>
            `;

            document.getElementById('confirmSendBtn').onclick = executeEmailSend;
            new bootstrap.Modal(document.getElementById('emailSendModal')).show();
        };

        async function executeEmailSend() {
            const target = document.getElementById('target_email').value;
            const note = document.getElementById('email_note').value;
            if (!target) return window.showAlert('Recipient email is required', 'warning');

            const confirmed = await window.showConfirm('Send Email', `Proceed to send booking details to ${target}?`);
            if (!confirmed) return;

            // 1. Fetch User Config
            const { data: config, error: configErr } = await supabase
                .from('user_email_config')
                .select('*')
                .eq('id', currentUser.id)
                .maybeSingle();

            if (!config || !config.google_script_url) {
                return window.showAlert('Please configure your Email Settings first!', 'error');
            }

            window.showAlert('Sending via Google Script...', 'info');

            // 2. Prepare Payload
            const payload = {
                to: target,
                subject: `Booking Details - ${selectedSaleForEmail.ref_num} | FLTT`,
                from_name: `${currentUser.email.split('@')[0].toUpperCase()} FLTT`,
                from_email: config.sender_email || currentUser.email, // Use alias from config
                body: `
                    <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto; border: 1px solid #eee; padding: 20px; border-radius: 10px;">
                        <h2 style="color: #123821; border-bottom: 2px solid #06d1fa; padding-bottom: 10px;">Booking Details</h2>
                        <p>${note}</p>
                        <table border="0" cellpadding="10" cellspacing="0" style="width: 100%; background: #f9fafb; border-radius: 8px; margin: 20px 0;">
                            <tr><td style="font-weight: bold; width: 150px;">Reference Number</td><td><b>${selectedSaleForEmail.ref_num}</b></td></tr>
                            <tr><td style="font-weight: bold;">Service Type</td><td style="color: #06967a;">${selectedSaleForEmail.service_type}</td></tr>
                            <tr><td style="font-weight: bold;">Customer Name</td><td>${selectedSaleForEmail.customer_name}</td></tr>
                            <tr><td style="font-weight: bold;">Final Amount</td><td><b>₹${parseFloat(selectedSaleForEmail.final_price).toLocaleString()}</b></td></tr>
                            <tr><td style="font-weight: bold;">Payment Status</td><td>${selectedSaleForEmail.payment_status}</td></tr>
                            <tr><td style="font-weight: bold;">Document ID</td><td>${selectedSaleForEmail.doc_num || 'N/A'}</td></tr>
                            ${selectedSaleForEmail.doc_link ? `<tr><td style="font-weight: bold;">View Documents</td><td><a href="${selectedSaleForEmail.doc_link}" style="color: #06d1fa; text-decoration: none; font-weight: bold;">Click to View / Download</a></td></tr>` : ''}
                        </table>
                        <p style="color: #666; font-size: 14px; margin-top: 30px;">
                            Best Regards,<br>
                            <b>${currentUser.email.split('@')[0].toUpperCase()}</b> - Fly Light Tours and Travels
                        </p>
                    </div>
                `
            };

            // 3. Trigger GAS Webhook
            try {
                // Using no-cors cause direct browser POSTs to GAS often trigger CORS blocks
                await fetch(config.google_script_url, {
                    method: 'POST',
                    mode: 'no-cors',
                    cache: 'no-cache',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Log to DB
                await supabase.from('sales_email_logs').insert([{
                    sale_id: selectedSaleForEmail.id,
                    sender_email: config.sender_email || currentUser.email,
                    recipient_email: target,
                    subject: payload.subject,
                    body_content: payload.body, // Save full HTML body
                    sent_by: currentUser.id
                }]);

                window.showAlert('Email trigger sent & logged successfully!', 'success');
                bootstrap.Modal.getInstance(document.getElementById('emailSendModal')).hide();
                loadSales(); // Reload to show updated log count

            } catch (e) {
                console.error(e);
                window.showAlert('Failed to trigger webhook. Check your network or script URL.', 'error');
            }
        }

        window.viewEmailLogs = (saleId) => {
            const logs = emailLogs.filter(l => l.sale_id == saleId);
            logs.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));

            const tbody = document.getElementById('emailLogsBody');
            if (logs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="text-center py-3 text-muted">No emails found for this sale.</td></tr>';
            } else {
                tbody.innerHTML = logs.map(l => `
                    <tr>
                        <td>
                            <div class="fw-600">${new Date(l.created_at).toLocaleDateString()}</div>
                            <div class="small text-muted">${new Date(l.created_at).toLocaleTimeString()}</div>
                        </td>
                        <td><span class="small">${l.sender_email}</span></td>
                        <td>${l.recipient_email}</td>
                        <td><span class="badge bg-success">Sent</span></td>
                        <td>
                            <button class="btn btn-sm btn-outline-info" type="button" data-bs-toggle="collapse" data-bs-target="#email-body-${l.id}">
                                View
                            </button>
                        </td>
                    </tr>
                    <tr class="collapse bg-light" id="email-body-${l.id}">
                        <td colspan="5" class="p-3">
                            <div class="small text-muted fw-bold">Subject: ${l.subject || 'N/A'}</div>
                            <hr class="my-1">
                            <div class="bg-white p-2 border rounded">${l.body_content || 'No content logged.'}</div>
                        </td>
                    </tr>
                `).join('');
            }

            new bootstrap.Modal(document.getElementById('emailLogsModal')).show();
        };

        init();
    </script>
</body>

</html>
