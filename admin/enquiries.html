<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Web Enquiries - FLTT</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">

    <!-- Favicon -->
    <link rel="shortcut icon" href="../assets/images/favicons/fev.admin.png" type="image/png">
    <link rel="icon" href="../assets/images/favicons/fev.admin.png" type="image/png">

    <!-- Icons -->
    <link rel="stylesheet" href="../assets/vendors/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="../assets/vendors/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../assets/css/admin-common.css" />

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--content-bg);
            color: var(--text-dark);
            margin: 0;
            display: none;
            /* Hidden for auth check */
        }

        .enquiry-card {
            background: #fff;
            border-radius: var(--radius);
            margin-bottom: 30px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
            overflow: hidden;
        }

        .table-responsive {
            padding: 0;
        }

        .table {
            margin-bottom: 0;
        }

        .table th {
            font-weight: 600;
            background-color: #f8f9fa;
            border-top: none;
            padding: 15px 20px;
            font-size: 0.9rem;
            color: var(--text-muted);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .table td {
            padding: 15px 20px;
            vertical-align: middle;
            font-size: 0.95rem;
            border-bottom: 1px solid #f0f0f0;
        }

        .status-badge {
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-new {
            background: rgba(232, 96, 76, 0.1);
            color: #e8604c;
        }

        .status-read {
            background: rgba(52, 152, 219, 0.1);
            color: #3498db;
        }

        .status-replied {
            background: rgba(26, 188, 156, 0.1);
            color: #1abc9c;
        }

        .status-archived {
            background: #f0f0f0;
            color: #666;
        }

        .type-badge {
            background: #f0f2f5;
            color: #475569;
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 600;
            margin-left: 5px;
        }

        .search-box {
            position: relative;
            max-width: 300px;
        }

        .search-box i {
            position: absolute;
            left: 12px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
        }

        .search-box input {
            padding-left: 35px;
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .details-modal-content {
            padding: 20px;
        }

        .detail-item {
            margin-bottom: 15px;
            border-bottom: 1px dased #eee;
            padding-bottom: 10px;
        }

        .detail-label {
            font-weight: 600;
            color: var(--text-muted);
            font-size: 0.8rem;
            display: block;
            margin-bottom: 2px;
        }

        .detail-value {
            color: var(--text-dark);
            font-size: 1rem;
        }

        .json-details {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 0.85rem;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>

    <script type="module">
        import { supabase } from '../assets/js/supabase-client.js';
        import { checkPageAuth } from '../assets/js/admin-auth-guard.js';

        async function initAuth() {
            const allowed = await checkPageAuth('nav-enquiries');
            if (allowed) {
                window.supabaseClient = supabase;
                document.body.style.display = 'block';
                loadEnquiries();
            }
        }
        initAuth();

        window.loadEnquiries = async () => {
            const { data, error } = await supabase
                .from('enquiries')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error fetching enquiries:', error);
                return;
            }

            renderEnquiries(data);
        };

        function renderEnquiries(enquiries) {
            const tbody = document.getElementById('enquiries-tbody');
            tbody.innerHTML = '';

            if (enquiries.length === 0) {
                tbody.innerHTML = `<tr><td colspan="6" class="text-center py-5">No enquiries found.</td></tr>`;
                return;
            }

            enquiries.forEach(enq => {
                const date = new Date(enq.created_at).toLocaleDateString('en-IN', {
                    day: '2-digit',
                    month: 'short',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });

                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${date}</td>
                    <td>
                        <strong>${enq.name || 'N/A'}</strong>
                        <span class="type-badge">${enq.type}</span>
                    </td>
                    <td>
                        <div>${enq.email || '-'}</div>
                        <div class="small text-muted">${enq.phone || '-'}</div>
                    </td>
                    <td>${enq.service || '-'}</td>
                    <td><span class="status-badge status-${enq.status}">${enq.status}</span></td>
                    <td>
                        <button class="btn btn-sm btn-outline-primary" onclick="viewDetails('${enq.id}')">
                            <i class="fas fa-eye"></i>
                        </button>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown">
                                <i class="fas fa-cog"></i>
                            </button>
                            <ul class="dropdown-menu">
                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="updateStatus('${enq.id}', 'new')">Mark as New</a></li>
                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="updateStatus('${enq.id}', 'read')">Mark as Read</a></li>
                                <li><a class="dropdown-item" href="javascript:void(0)" onclick="updateStatus('${enq.id}', 'replied')">Mark as Replied</a></li>
                                <li><hr class="dropdown-divider"></li>
                                <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="updateStatus('${enq.id}', 'archived')">Archive</a></li>
                                <li><a class="dropdown-item text-danger" href="javascript:void(0)" onclick="deleteEnquiry('${enq.id}')">Delete</a></li>
                            </ul>
                        </div>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        window.viewDetails = async (id) => {
            const { data, error } = await supabase.from('enquiries').select('*').eq('id', id).single();
            if (error) return;

            const modalBody = document.getElementById('enquiry-modal-body');
            let detailsHtml = `
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <span class="detail-label">Name</span>
                        <span class="detail-value">${data.name || 'N/A'}</span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <span class="detail-label">Type</span>
                        <span class="detail-value text-uppercase">${data.type}</span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <span class="detail-label">Email</span>
                        <span class="detail-value">${data.email || 'N/A'}</span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <span class="detail-label">Phone</span>
                        <span class="detail-value">${data.phone || 'N/A'}</span>
                    </div>
                    <div class="col-12 mb-3">
                        <span class="detail-label">Service</span>
                        <span class="detail-value">${data.service || 'N/A'}</span>
                    </div>
            `;

            if (data.subject) {
                detailsHtml += `
                    <div class="col-12 mb-3">
                        <span class="detail-label">Subject</span>
                        <span class="detail-value">${data.subject}</span>
                    </div>
                `;
            }

            if (data.message) {
                detailsHtml += `
                    <div class="col-12 mb-3">
                        <span class="detail-label">Message</span>
                        <div class="detail-value" style="white-space: pre-wrap; background: #fcfcfc; padding: 10px; border: 1px solid #f0f0f0; border-radius: 4px;">${data.message}</div>
                    </div>
                `;
            }

            if (data.details && Object.keys(data.details).length > 0) {
                detailsHtml += `
                    <div class="col-12 mb-3">
                        <span class="detail-label">Form Details</span>
                        <div class="json-details">
                            ${Object.entries(data.details).map(([k, v]) => `<div><strong>${k}:</strong> ${v}</div>`).join('')}
                        </div>
                    </div>
                `;
            }

            detailsHtml += `
                    <div class="col-12 mb-3">
                        <span class="detail-label">Source URL</span>
                        <a href="${data.source_url}" target="_blank" class="small text-truncate d-block">${data.source_url}</a>
                    </div>
                </div>
            `;

            modalBody.innerHTML = detailsHtml;
            const modal = new bootstrap.Modal(document.getElementById('enquiryModal'));
            modal.show();

            // Mark as read if it was new
            if (data.status === 'new') {
                updateStatus(id, 'read', false);
            }
        };

        window.updateStatus = async (id, status, reload = true) => {
            const { error } = await supabase.from('enquiries').update({ status }).eq('id', id);
            if (error) {
                window.showAlert('Error updating status', 'error');
            } else if (reload) {
                loadEnquiries();
            }
        };

        window.deleteEnquiry = async (id) => {
            const confirm = await window.showConfirm('Delete Enquiry', 'Are you sure you want to delete this enquiry?');
            if (!confirm) return;

            const { error } = await supabase.from('enquiries').delete().eq('id', id);
            if (error) {
                window.showAlert('Error deleting enquiry', 'error');
            } else {
                loadEnquiries();
            }
        };

        // Filter Functionality
        document.getElementById('filter-search').addEventListener('input', (e) => {
            const term = e.target.value.toLowerCase();
            const rows = document.querySelectorAll('#enquiries-tbody tr');
            rows.forEach(row => {
                const text = row.innerText.toLowerCase();
                row.style.display = text.includes(term) ? '' : 'none';
            });
        });

        document.getElementById('filter-type').addEventListener('change', (e) => {
            const type = e.target.value;
            const rows = document.querySelectorAll('#enquiries-tbody tr');
            rows.forEach(row => {
                const badge = row.querySelector('.type-badge').innerText;
                row.style.display = (!type || badge === type) ? '' : 'none';
            });
        });

        document.getElementById('filter-status').addEventListener('change', (e) => {
            const status = e.target.value;
            const rows = document.querySelectorAll('#enquiries-tbody tr');
            rows.forEach(row => {
                const badge = row.querySelector('.status-badge').innerText.toLowerCase();
                row.style.display = (!status || badge === status) ? '' : 'none';
            });
        });

    </script>
</head>

<body>

    <div class="dashboard-container">

        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="main-content">

            <!-- Topbar -->
            <div class="topbar">
                <div class="user-profile">
                    <div class="user-info">
                        <div class="user-name">Loading...</div>
                        <div class="user-role">...</div>
                    </div>
                    <div class="avatar">?</div>
                    <button onclick="handleLogout()" class="btn btn-outline-danger btn-sm ms-3"
                        style="border-radius: 50%; width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="content-wrapper">

                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h1 class="page-title mb-0">Web Enquiries</h1>
                    <div class="d-flex gap-3">
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="filter-search" class="form-control"
                                placeholder="Search enquiries...">
                        </div>
                        <select id="filter-type" class="form-select" style="width: 150px;">
                            <option value="">All Types</option>
                            <option value="contact">Contact</option>
                            <option value="flight">Flight</option>
                            <option value="fleet">Taxi/Bus</option>
                            <option value="insurance_buy">Ins. Buy</option>
                            <option value="insurance_claim">Ins. Claim</option>
                        </select>
                        <select id="filter-status" class="form-select" style="width: 150px;">
                            <option value="">All Status</option>
                            <option value="new">New</option>
                            <option value="read">Read</option>
                            <option value="replied">Replied</option>
                            <option value="archived">Archived</option>
                        </select>
                        <button class="btn btn-primary" onclick="loadEnquiries()">
                            <i class="fas fa-sync-alt"></i>
                        </button>
                    </div>
                </div>

                <div class="enquiry-card">
                    <div class="table-responsive">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Date</th>
                                    <th>Visitor</th>
                                    <th>Contact Info</th>
                                    <th>Service</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="enquiries-tbody">
                                <tr>
                                    <td colspan="6" class="text-center py-5">
                                        <div class="spinner-border text-primary" role="status">
                                            <span class="visually-hidden">Loading...</span>
                                        </div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Enquiry Details Modal -->
    <div class="modal fade" id="enquiryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content"
                style="border-radius: 12px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                <div class="modal-header" style="border-bottom: 1px solid #f0f0f0;">
                    <h5 class="modal-title">Enquiry Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body" id="enquiry-modal-body">
                    <!-- Dynamic Content -->
                </div>
                <div class="modal-footer" style="border-top: 1px solid #f0f0f0;">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Scripts -->
    <script src="../assets/js/admin-sidebar-loader.js"></script>
    <script type="module" src="../assets/js/admin-announcement-checker.js"></script>
    <script src="../assets/vendors/bootstrap/js/bootstrap.bundle.min.js"></script>

</body>

</html>