<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Portals - FLTT Admin</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="shortcut icon" href="../assets/images/favicons/fev.admin.png" type="image/png">
    <link rel="icon" href="../assets/images/favicons/fev.admin.png" type="image/png">

    <!-- Icons -->
    <link rel="stylesheet" href="../assets/vendors/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="../assets/vendors/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../assets/css/admin-common.css" />

    <style>
        body {
            font-family: 'Outfit', sans-serif;
            background-color: var(--content-bg);
            color: var(--text-dark);
            margin: 0;
            display: none;
            /* Hidden for auth check */
        }
    </style>

    <script type="module">
        import { supabase } from '../assets/js/supabase-client.js';
        import { checkPageAuth } from '../assets/js/admin-auth-guard.js';

        async function initAuth() {
            const allowed = await checkPageAuth('nav-manage-booking-site');
            if (allowed) {
                window.supabaseClient = supabase;
                document.body.style.display = 'block';
            }
        }
        initAuth();
    </script>
</head>

<body>

    <div class="dashboard-container">

        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <!-- Main Content -->
        <main class="main-content">

            <!-- Topbar -->
            <div class="topbar">
                <div class="user-profile">
                    <div class="user-info">
                        <div class="user-name">Loading...</div>
                        <div class="user-role">...</div>
                    </div>
                    <div class="avatar">?</div>
                    <button onclick="handleLogout()" class="btn btn-outline-danger btn-sm ms-3"
                        style="border-radius: 50%; width: 32px; height: 32px; padding: 0; display: flex; align-items: center; justify-content: center;">
                        <i class="fas fa-sign-out-alt"></i>
                    </button>
                </div>
            </div>

            <!-- Content -->
            <div class="content-wrapper">

                <h1 class="page-title">Manage Portals</h1>
                <div class="content-card">
                    <div class="d-flex justify-content-between align-items-center mb-4 border-bottom pb-3">
                        <div class="card-heading m-0 b-0 border-0">
                            <i class="fas fa-desktop"></i> Platform Registry
                        </div>
                        <button onclick="openBookingSiteModal()" class="btn btn-custom btn-sm">
                            <i class="fas fa-plus me-1"></i> Add Platform
                        </button>
                    </div>
                    <div class="table-responsive" id="bookingTableWrapper">
                        <table class="table table-hover align-middle">
                            <thead class="table-light">
                                <tr>
                                    <th>Platform Name</th>
                                    <th>Username</th>
                                    <th>Password</th>
                                    <th>Category</th>
                                    <th style="width: 150px; text-align: center;">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="bookingSitesTableBody">
                                <tr>
                                    <td colspan="4" class="text-center py-4">
                                        <div class="spinner-border text-primary" role="status"></div>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- Booking Site Modal -->
    <div class="modal fade" id="bookingSiteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content"
                style="border-radius: 15px; border: none; box-shadow: 0 10px 30px rgba(0,0,0,0.1);">
                <div class="modal-header">
                    <h5 class="modal-title fw-bold" id="bookingModalTitle">Add Portal</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="bookingSiteId">
                    <div class="mb-3">
                        <label class="form-label fw-600">Platform Name</label>
                        <input type="text" class="form-control" id="bookingSiteName" placeholder="e.g. FlightHub">
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-600">Category</label>
                        <select class="form-select" id="bookingSiteCategory">
                            <option value="booking">Booking Portal</option>
                            <option value="insurance">Insurance Portal</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-600">Portal URL</label>
                        <input type="url" class="form-control" id="bookingSiteUrl" placeholder="https://...">
                    </div>
                    <div class="row">
                        <div class="col-6 mb-3">
                            <label class="form-label fw-600">Username / ID</label>
                            <input type="text" class="form-control" id="bookingSiteUser">
                        </div>
                        <div class="col-6 mb-3">
                            <label class="form-label fw-600">Password</label>
                            <input type="text" class="form-control" id="bookingSitePass">
                        </div>
                    </div>
                    <div class="mb-3 form-check ms-1">
                        <input type="checkbox" class="form-check-input" id="bookingSiteExternal">
                        <label class="form-check-label fw-500" for="bookingSiteExternal">Open in New Tab by default (Use
                            for sites that block embedding)</label>
                    </div>
                    <div id="bookingModalStatus" class="status-msg"></div>
                </div>
                <div class="modal-footer border-top-0 pt-0">
                    <button type="button" class="btn btn-light" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" onclick="saveBookingSite()" class="btn btn-custom px-4">Save Platform</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Custom Scripts -->
    <script src="../assets/js/admin-sidebar-loader.js"></script>
    <script src="../assets/vendors/bootstrap/js/bootstrap.bundle.min.js"></script>

    <script type="module">
        import { saveContent, fetchContent } from '../assets/js/supabase-client.js';

        const BOOKING_KEY = 'admin_booking_sites_json';
        const bookingModal = new bootstrap.Modal(document.getElementById('bookingSiteModal'));
        let bookingSites = [];

        async function loadBookingSites() {
            const data = await fetchContent(BOOKING_KEY);
            try { bookingSites = data ? JSON.parse(data) : []; } catch (e) { bookingSites = []; }
        }

        const showStatus = (el, type, msg) => {
            el.textContent = msg;
            el.className = `status-msg active ${type}`;
            if (type === 'success') setTimeout(() => el.className = 'status-msg', 3000);
        };

        window.openBookingSiteModal = (id = null) => {
            const site = id ? bookingSites.find(s => s.id === id) : null;
            document.getElementById('bookingSiteId').value = id || '';
            document.getElementById('bookingSiteName').value = site ? site.name : '';
            document.getElementById('bookingSiteUrl').value = site ? site.url : '';
            document.getElementById('bookingSiteUser').value = site ? site.user : '';
            document.getElementById('bookingSitePass').value = site ? site.pass : '';
            document.getElementById('bookingSiteCategory').value = site ? site.category || 'booking' : 'booking';
            document.getElementById('bookingSiteExternal').checked = site ? !!site.external : false;
            document.getElementById('bookingModalTitle').innerText = id ? 'Edit Platform' : 'Add Portal';
            bookingModal.show();
        };

        window.saveBookingSite = async () => {
            const id = document.getElementById('bookingSiteId').value || Date.now().toString();
            const name = document.getElementById('bookingSiteName').value;
            const url = document.getElementById('bookingSiteUrl').value;
            const user = document.getElementById('bookingSiteUser').value;
            const pass = document.getElementById('bookingSitePass').value;
            const category = document.getElementById('bookingSiteCategory').value;
            const external = document.getElementById('bookingSiteExternal').checked;

            if (!name || !url) {
                window.showAlert('Platform name and URL are required', 'warning');
                return;
            }

            const isEdit = !!document.getElementById('bookingSiteId').value;
            const confirmed = await window.showConfirm(isEdit ? 'Update Platform' : 'Save Platform', `Are you sure you want to ${isEdit ? 'update' : 'add'} "${name}"?`);
            if (!confirmed) return;

            const existingIndex = bookingSites.findIndex(s => s.id === id);
            if (existingIndex > -1) bookingSites[existingIndex] = { id, name, url, user, pass, category, external };
            else bookingSites.push({ id, name, url, user, pass, category, external });

            const statusEl = document.getElementById('bookingModalStatus');
            showStatus(statusEl, 'loading', 'Saving sites...');

            const res = await saveContent(BOOKING_KEY, JSON.stringify(bookingSites));
            if (!res.error) {
                showStatus(statusEl, 'success', 'Registry updated!');
                setTimeout(() => { bookingModal.hide(); renderBookingTable(); }, 1000);
            } else {
                showStatus(statusEl, 'error', res.error.message);
            }
        };

        window.deleteBookingSite = async (id) => {
            const confirmed = await window.showConfirm('Remove Platform', 'Are you sure you want to remove this platform from the registry?');
            if (confirmed) {
                bookingSites = bookingSites.filter(s => s.id !== id);
                const res = await saveContent(BOOKING_KEY, JSON.stringify(bookingSites));
                if (!res.error) {
                    renderBookingTable();
                    window.showAlert('Platform removed successfully', 'success');
                } else {
                    window.showAlert('Failed to remove: ' + res.error.message, 'error');
                }
            }
        };

        window.renderBookingTable = async () => {
            await loadBookingSites();
            const tbody = document.getElementById('bookingSitesTableBody');
            tbody.innerHTML = bookingSites.map(s => `
                <tr>
                    <td>
                        <div class="fw-600">${s.name}</div>
                        <small class="${s.external ? 'text-warning' : 'text-muted'}">
                            ${s.external ? '<i class="fas fa-external-link-alt"></i> Opens in New Tab' : 'Iframe Mode'}
                        </small>
                    </td>
                    <td>${s.user}</td>
                    <td>
                        <span class="badge ${s.category === 'insurance' ? 'bg-info' : 'bg-primary'} text-uppercase" style="font-size: 10px;">
                            ${s.category || 'booking'}
                        </span>
                    </td>
                    <td>••••••••</td>
                    <td class="text-center">
                        <button class="btn btn-sm btn-outline-info me-2" onclick="openBookingSiteModal('${s.id}')"><i class="fas fa-edit"></i></button>
                        <button class="btn btn-sm btn-outline-danger" onclick="deleteBookingSite('${s.id}')"><i class="fas fa-trash"></i></button>
                    </td>
                </tr>
            `).join('') || '<tr><td colspan="4" class="text-center py-4 text-muted">No platforms added yet.</td></tr>';
        };

        renderBookingTable();
    </script>
</body>

</html>