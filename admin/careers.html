<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Manage Careers - FLTT Admin</title>

    <!-- Fonts & Icons -->
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/vendors/fontawesome/css/all.min.css" />
    <link rel="stylesheet" href="../assets/vendors/bootstrap/css/bootstrap.min.css" />
    <link rel="stylesheet" href="../assets/css/admin-common.css" />
    <link rel="shortcut icon" href="../assets/images/favicons/fev.admin.png" type="image/png">

    <style>
        .tabs-nav {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
            border-bottom: 1px solid #eee;
            padding-bottom: 10px;
        }

        .tab-link {
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
            transition: 0.2s;
        }

        .tab-link.active {
            background: #e8604c;
            color: white;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Lists */
        .job-list-item,
        .app-list-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            margin-bottom: 15px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.03);
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid #eee;
        }

        .status-badge {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active {
            background: #dcfce7;
            color: #166534;
        }

        .status-inactive {
            background: #f3f4f6;
            color: #4b5563;
        }

        /* App Status */
        .status-new {
            background: #dbeafe;
            color: #1e40af;
        }

        .status-reviewed {
            background: #fef9c3;
            color: #854d0e;
        }

        .status-hired {
            background: #dcfce7;
            color: #166534;
        }

        .status-rejected {
            background: #fee2e2;
            color: #991b1b;
        }
    </style>
</head>

<body>

    <div class="dashboard-container">
        <!-- Sidebar -->
        <div id="sidebar-container"></div>

        <main class="main-content">
            <div class="topbar justify-content-between">
                <h2 style="font-size: 1.5rem; font-weight: 700; margin: 0;">Careers Management</h2>
                <div class="user-profile">
                    <!-- Default Topbar Profile -->
                    <button onclick="handleLogout()" class="btn btn-outline-danger btn-sm">
                        <i class="fas fa-sign-out-alt"></i> Logout
                    </button>
                </div>
            </div>

            <div class="content-wrapper">

                <div class="tabs-nav">
                    <div class="tab-link active" onclick="switchTab('jobs')">Manage Jobs</div>
                    <div class="tab-link" onclick="switchTab('applications')">Applications</div>
                </div>

                <!-- JOBS TAB -->
                <div id="tab-jobs" class="tab-content active">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4>Open Positions</h4>
                        <button class="btn btn-primary" onclick="openJobModal()">
                            <i class="fas fa-plus"></i> Post New Job
                        </button>
                    </div>

                    <div id="jobsList">
                        <!-- Loaded dynamically -->
                        <div class="text-center p-5"><span class="spinner-border"></span></div>
                    </div>
                </div>

                <!-- APPLICATIONS TAB -->
                <div id="tab-applications" class="tab-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h4>Received Applications</h4>
                        <select id="appFilterJob" class="form-select w-auto" onchange="loadApplications()">
                            <option value="all">All Jobs</option>
                        </select>
                    </div>

                    <div id="applicationsList">
                        <!-- Loaded dynamically -->
                    </div>
                </div>

            </div>
        </main>
    </div>

    <!-- JOB MODAL -->
    <div class="modal fade" id="jobModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="jobModalTitle">Post New Job</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <form id="jobForm">
                        <input type="hidden" id="editJobId">

                        <div class="mb-3">
                            <label class="form-label">Job Title</label>
                            <input type="text" class="form-control" name="title" required>
                        </div>

                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Location</label>
                                <input type="text" class="form-control" name="location"
                                    placeholder="e.g. Remote, Mumbai, etc." required>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label class="form-label">Type</label>
                                <select class="form-select" name="type">
                                    <option>Full-time</option>
                                    <option>Part-time</option>
                                    <option>Contract</option>
                                    <option>Internship</option>
                                </select>
                            </div>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Description</label>
                            <textarea class="form-control" name="description" rows="5" required></textarea>
                        </div>

                        <div class="mb-3">
                            <label class="form-label">Requirements</label>
                            <textarea class="form-control" name="requirements" rows="3"
                                placeholder="List key requirements..."></textarea>
                        </div>

                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="jobActive" checked>
                            <label class="form-check-label" for="jobActive">Active (Visible to public)</label>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-primary" onclick="saveJob()">Save Job</button>
                </div>
            </div>
        </div>
    </div>

    <!-- APPLICATION DETAIL MODAL -->
    <div class="modal fade" id="appModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Application Details</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>Name:</strong> <span id="viewAppName"></span></p>
                            <p><strong>Email:</strong> <span id="viewAppEmail"></span></p>
                            <p><strong>Phone:</strong> <span id="viewAppPhone"></span></p>
                        </div>
                        <div class="col-md-6 text-end">
                            <p><strong>Applied For:</strong> <span id="viewAppJob"></span></p>
                            <p><strong>Date:</strong> <span id="viewAppDate"></span></p>
                        </div>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Resume / Portfolio Link</label>
                        <div>
                            <a href="#" target="_blank" id="viewAppResume"
                                class="btn btn-sm btn-outline-primary">Opening...</a>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Cover Letter</label>
                        <div id="viewAppCover" class="p-3 bg-light rounded"></div>
                    </div>

                    <hr>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Update Status</label>
                        <select class="form-select w-auto" id="viewAppStatus">
                            <option value="new">New</option>
                            <option value="reviewed">Reviewed</option>
                            <option value="hired">Hired</option>
                            <option value="rejected">Rejected</option>
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Internal Notes</label>
                        <textarea class="form-control" id="viewAppNotes" rows="2"
                            placeholder="Private notes..."></textarea>
                    </div>

                    <hr>
                    <div class="mb-3">
                        <label class="form-label fw-bold">Email Communication History</label>
                        <div id="emailHistoryList" class="p-3 bg-light rounded"
                            style="max-height: 200px; overflow-y: auto;">
                            <!-- Dynamically loaded -->
                            <p class="text-muted small mb-0">No emails sent yet.</p>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <input type="hidden" id="viewAppId">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" onclick="updateApplication()">Update Status</button>
                </div>
            </div>
        </div>
    </div>


    <script src="../assets/vendors/bootstrap/js/bootstrap.bundle.min.js"></script>
    <script src="../assets/js/admin-sidebar-loader.js"></script>

    <script type="module">
        import { supabase } from '../assets/js/supabase-client.js';
        import { checkPageAuth } from '../assets/js/admin-auth-guard.js';

        // Custom Alert Function
        window.showAlert = (message, type = 'info') => {
            // Map types: success, danger, warning, info
            const validTypes = ['success', 'danger', 'warning', 'info'];
            if (!validTypes.includes(type)) type = 'info';

            const container = document.querySelector('.content-wrapper');
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type} alert-dismissible fade show shadow-sm`;
            alertDiv.style.position = 'fixed';
            alertDiv.style.top = '20px';
            alertDiv.style.right = '20px';
            alertDiv.style.zIndex = '10000';
            alertDiv.style.minWidth = '300px';
            alertDiv.role = 'alert';
            alertDiv.innerHTML = `
                <strong>${type.charAt(0).toUpperCase() + type.slice(1)}:</strong> ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            `;
            document.body.appendChild(alertDiv);

            // Auto dismiss after 5s
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        };

        // Auth & Permission Check
        async function init() {
            const allowed = await checkPageAuth('nav-careers');
            if (!allowed) return;

            loadJobs();
            loadApplications();
            loadEmailConfig(); // Load config for sending emails
        }
        init();

        let emailConfig = null;
        async function loadEmailConfig() {
            // Fetch configuration for the current user
            const { data: { user } } = await supabase.auth.getUser();
            const { data } = await supabase
                .from('user_email_config')
                .select('google_script_url, sender_email')
                .eq('id', user.id)
                .maybeSingle();
            emailConfig = data;
        }

        window.switchTab = (tab) => {
            document.querySelectorAll('.tab-content').forEach(el => el.classList.remove('active'));
            document.querySelectorAll('.tab-link').forEach(el => el.classList.remove('active'));
            document.getElementById(`tab-${tab}`).classList.add('active');
            document.querySelector(`.tab-link[onclick="switchTab('${tab}')"]`).classList.add('active');
        };

        // --- JOBS ---

        window.loadJobs = async () => {
            const list = document.getElementById('jobsList');
            const { data: jobs, error } = await supabase
                .from('jobs')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                list.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
                return;
            }

            // Populate Filter in Apps Tab
            const filter = document.getElementById('appFilterJob');
            filter.innerHTML = '<option value="all">All Jobs</option>';
            jobs.forEach(j => {
                const opt = document.createElement('option');
                opt.value = j.id;
                opt.textContent = j.title;
                filter.appendChild(opt);
            });

            if (!jobs.length) {
                list.innerHTML = `<div class="text-muted text-center p-4">No jobs posted yet.</div>`;
                return;
            }

            list.innerHTML = jobs.map(job => `
                <div class="job-list-item">
                    <div>
                        <h5 style="margin-bottom:5px;">${job.title}</h5>
                        <div class="text-muted small">${job.location} â€¢ ${job.type}</div>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <span class="status-badge ${job.is_active ? 'status-active' : 'status-inactive'}">
                            ${job.is_active ? 'Active' : 'Inactive'}
                        </span>
                        <div class="btn-group">
                            <button class="btn btn-sm btn-outline-secondary" onclick="editJob(${job.id})"><i class="fas fa-edit"></i></button>
                            <button class="btn btn-sm btn-outline-danger" onclick="deleteJob(${job.id})"><i class="fas fa-trash"></i></button>
                        </div>
                    </div>
                </div>
            `).join('');
        };

        const jobModal = new bootstrap.Modal(document.getElementById('jobModal'));
        let currentJobs = []; // Cache for edit

        window.openJobModal = () => {
            document.getElementById('jobForm').reset();
            document.getElementById('editJobId').value = '';
            document.getElementById('jobModalTitle').textContent = 'Post New Job';
            document.getElementById('jobActive').checked = true;
            jobModal.show();
        };

        window.editJob = async (id) => {
            const { data: job } = await supabase.from('jobs').select('*').eq('id', id).single();
            if (!job) return;

            const f = document.querySelector('#jobForm');
            f.querySelector('[name="title"]').value = job.title;
            f.querySelector('[name="location"]').value = job.location;
            f.querySelector('[name="type"]').value = job.type;
            f.querySelector('[name="description"]').value = job.description;
            f.querySelector('[name="requirements"]').value = job.requirements || '';
            document.getElementById('jobActive').checked = job.is_active;
            document.getElementById('editJobId').value = job.id;

            document.getElementById('jobModalTitle').textContent = 'Edit Job';
            jobModal.show();
        };

        window.saveJob = async () => {
            const f = document.querySelector('#jobForm');
            const data = {
                title: f.querySelector('[name="title"]').value,
                location: f.querySelector('[name="location"]').value,
                type: f.querySelector('[name="type"]').value,
                description: f.querySelector('[name="description"]').value,
                requirements: f.querySelector('[name="requirements"]').value,
                is_active: document.getElementById('jobActive').checked
            };

            const id = document.getElementById('editJobId').value;
            let error;

            if (id) {
                const res = await supabase.from('jobs').update(data).eq('id', id);
                error = res.error;
            } else {
                const res = await supabase.from('jobs').insert([data]);
                error = res.error;
            }

            if (error) {
                showAlert('Error: ' + error.message, 'danger');
            } else {
                jobModal.hide();
                loadJobs();
                showAlert('Job saved successfully!', 'success');
            }
        };

        window.deleteJob = async (id) => {
            if (!confirm('Delete this job? This will not notify applicants.')) return;
            const { error } = await supabase.from('jobs').delete().eq('id', id);
            if (error) showAlert(error.message, 'danger');
            else {
                loadJobs();
                showAlert('Job deleted.', 'success');
            }
        };


        // --- APPLICATIONS ---

        window.loadApplications = async () => {
            const list = document.getElementById('applicationsList');
            const filterJobId = document.getElementById('appFilterJob').value;

            let query = supabase
                .from('job_applications')
                .select(`
                    *,
                    jobs (title)
                `)
                .order('created_at', { ascending: false });

            if (filterJobId !== 'all') {
                query = query.eq('job_id', filterJobId);
            }

            const { data: apps, error } = await query;

            if (error) {
                list.innerHTML = `<div class="alert alert-danger">${error.message}</div>`;
                return;
            }

            if (!apps.length) {
                list.innerHTML = `<div class="text-muted text-center p-4">No applications received.</div>`;
                return;
            }

            list.innerHTML = apps.map(app => `
                <div class="app-list-item">
                    <div>
                        <h6 style="margin:0;">${app.applicant_name}</h6>
                        <small class="text-muted">Applied for: ${app.jobs?.title || 'Unknown Job'}</small>
                        <div class="text-muted small" style="font-size:12px;">${new Date(app.created_at).toLocaleDateString()}</div>
                    </div>
                    <div class="d-flex align-items-center gap-3">
                        <span class="status-badge status-${app.status}">${app.status.toUpperCase()}</span>
                        <button class="btn btn-sm btn-light" onclick="viewApp(${app.id})">View Details</button>
                    </div>
                </div>
            `).join('');
        };

        const appModal = new bootstrap.Modal(document.getElementById('appModal'));

        window.viewApp = async (id) => {
            const { data: app } = await supabase
                .from('job_applications')
                .select(`*, jobs (title)`)
                .eq('id', id)
                .single();

            if (!app) return;

            document.getElementById('viewAppName').textContent = app.applicant_name;
            document.getElementById('viewAppEmail').textContent = app.applicant_email;
            document.getElementById('viewAppPhone').textContent = app.applicant_phone;
            document.getElementById('viewAppJob').textContent = app.jobs?.title;
            document.getElementById('viewAppDate').textContent = new Date(app.created_at).toLocaleString();

            const resumeLink = document.getElementById('viewAppResume');
            resumeLink.href = app.resume_url;
            resumeLink.textContent = app.resume_url;

            document.getElementById('viewAppCover').textContent = app.cover_letter || 'No cover letter provided.';

            document.getElementById('viewAppStatus').value = app.status;
            document.getElementById('viewAppNotes').value = app.notes || '';
            document.getElementById('viewAppId').value = app.id;
            document.getElementById('viewAppStatus').dataset.originalStatus = app.status; // Store original status

            await loadEmailHistory(app.id); // Load history

            appModal.show();
        };

        window.loadEmailHistory = async (appId) => {
            const list = document.getElementById('emailHistoryList');
            list.innerHTML = '<p class="text-muted small">Loading history...</p>';

            const { data: logs, error } = await supabase
                .from('application_email_logs')
                .select('*')
                .eq('application_id', appId)
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Error loading email history:', error);
                list.innerHTML = `<div class="alert alert-warning small mb-0">
                    <i class="fas fa-exclamation-triangle"></i> Could not load history.
                    <br>Error: ${error.message}
                </div>`;
                return;
            }

            if (!logs || !logs.length) {
                list.innerHTML = '<p class="text-muted small mb-0">No emails sent yet.</p>';
                return;
            }

            list.innerHTML = logs.map(log => `
                <div class="border-bottom pb-2 mb-2">
                    <div class="d-flex justify-content-between">
                        <strong style="font-size:13px;">${log.action_type === 'status_email' ? 'Status Update' : 'Email'}</strong>
                        <span class="text-muted" style="font-size:11px;">${new Date(log.created_at).toLocaleString()}</span>
                    </div>
                    <div style="font-size:12px;" class="text-truncate" title="${log.email_subject || ''}">Subject: ${log.email_subject || 'No subject'}</div>
                     <div style="font-size:12px;" class="badge ${log.sent_status === 'sent' ? 'bg-success' : 'bg-danger'}">${log.sent_status}</div>
                </div>
            `).join('');
        };

        window.updateApplication = async () => {
            const id = document.getElementById('viewAppId').value;
            const status = document.getElementById('viewAppStatus').value;
            const originalStatus = document.getElementById('viewAppStatus').dataset.originalStatus;
            const notes = document.getElementById('viewAppNotes').value;

            // Update application
            const { error } = await supabase.from('job_applications')
                .update({ status, notes })
                .eq('id', id);

            if (error) {
                showAlert(error.message, 'danger');
                return;
            }

            // Check if status changed
            if (status !== originalStatus) {
                const confirmed = confirm(`Status changed from ${originalStatus} to ${status}. Send email notification to applicant?`);
                if (confirmed) {
                    await sendStatusEmail(id, status);
                }
            }

            appModal.hide();
            loadApplications();
            showAlert('Application status updated.', 'success');
        };

        async function sendStatusEmail(appId, newStatus) {
            if (!emailConfig || !emailConfig.google_script_url) {
                alert("Email configuration missing. Please configure Email Webhook in settings.");
                return;
            }

            // Fetch app details again to get name/email
            const { data: app } = await supabase
                .from('job_applications')
                .select(`*, jobs(title)`)
                .eq('id', appId)
                .single();

            if (!app) return;

            // Construct Email Content based on Status
            const statusTemplates = {
                'reviewed': {
                    subject: `Update on your application for ${app.jobs.title}`,
                    body: `<p>Dear ${app.applicant_name},</p><p>We have reviewed your application for the <b>${app.jobs.title}</b> position. Your profile is impressive, and we are currently considering it for the next steps.</p><p>We will be in touch soon.</p><p>Best regards,<br>Hiring Team</p>`
                },
                'hired': {
                    subject: `Congratulations! Offer for ${app.jobs.title}`,
                    body: `<p>Dear ${app.applicant_name},</p><p>We are pleased to inform you that you have been selected for the <b>${app.jobs.title}</b> position! Congratulations!</p><p>We will send the official offer letter shortly.</p><p>Best regards,<br>Hiring Team</p>`
                },
                'rejected': {
                    subject: `Update on your application for ${app.jobs.title}`,
                    body: `<p>Dear ${app.applicant_name},</p><p>Thank you for your interest in the <b>${app.jobs.title}</b> position. After careful review, we have decided to move forward with other candidates who more closely match our requirements.</p><p>We wish you all the best in your job search.</p><p>Best regards,<br>Hiring Team</p>`
                },
                'new': {
                    subject: `Application Received: ${app.jobs.title}`,
                    body: `<p>Dear ${app.applicant_name},</p><p>We have received your application for <b>${app.jobs.title}</b>. We will review it shortly.</p>`
                }
            };

            const template = statusTemplates[newStatus] || statusTemplates['new'];

            // Prepare Payload
            const payload = {
                to: app.applicant_email,
                subject: template.subject,
                body: template.body,
                from_email: emailConfig.sender_email
            };

            try {
                // Send via GAS
                await fetch(emailConfig.google_script_url, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                // Start: Log in DB
                const logData = {
                    application_id: appId,
                    action_type: 'status_email',
                    email_subject: template.subject,
                    email_body: template.body,
                    sent_status: 'sent',
                    sent_by: (await supabase.auth.getUser()).data.user.id
                };

                const { error: dbError } = await supabase.from('application_email_logs').insert([logData]);

                if (dbError) {
                    console.error('DB Log Error:', dbError);
                    showAlert(`Email sent, but failed to save log: ${dbError.message}`, 'warning');
                } else {
                    showAlert(`Email notification sent for status: ${newStatus}`, 'success');
                    // Refresh history if modal is open
                    if (document.getElementById('viewAppId').value == appId) {
                        loadEmailHistory(appId);
                    }
                }

            } catch (e) {
                console.error(e);
                showAlert("Failed to send email via script.", 'danger');

                // Try to log failure
                const logData = {
                    application_id: appId,
                    action_type: 'status_email',
                    email_subject: template.subject,
                    email_body: "FAILED: " + e.message,
                    sent_status: 'failed',
                    sent_by: (await supabase.auth.getUser()).data.user.id
                };

                await supabase.from('application_email_logs').insert([logData]);

                // Refresh history
                if (document.getElementById('viewAppId').value == appId) {
                    loadEmailHistory(appId);
                }
            }
        }

        // Export global functions
        window.handleLogout = async () => {
            await supabase.auth.signOut();
            window.location.href = 'login.html';
        };

    </script>
</body>

</html>